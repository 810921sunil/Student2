<!DOCTYPE html>
<html>
<head>
  <title>Driver Panel - Live Location Update</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; text-align: center; background: #f9f9f9; }
    input, button { padding: 10px; margin: 10px 0; width: 100%; font-size: 16px; }
    #status { margin-top: 15px; font-weight: bold; }
    #logoutBtn { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>üöç Driver Panel - Update Location</h2>

  <div id="loginBox">
    <input type="text" id="driverId" placeholder="Driver ID" />
    <input type="password" id="driverPass" placeholder="Password" />
    <button onclick="loginDriver()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <div id="driverPanel" style="display:none;">
    <p>Welcome, <span id="driverName"></span>!</p>
    <button onclick="startTracking()">Start Location Update</button>
    <button onclick="stopTracking()" disabled id="stopBtn">Stop Location Update</button>
    <button id="logoutBtn" onclick="logoutDriver()">Logout</button>
    <p id="status"></p>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
    // ‚úÖ Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA01RW_-AK7DzZp9sd92GDZpExIVvMVbBY",
      authDomain: "ringasbustracker.firebaseapp.com",
      databaseURL: "https://ringasbustracker-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ringasbustracker",
      storageBucket: "ringasbustracker.firebasestorage.app",
      messagingSenderId: "894338476193",
      appId: "1:894338476193:web:125d89e35d8ada1822a8e0"
    };

    // ‚úÖ Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let watchId = null;
    let currentDriverId = null;
    let driverRoute = null;

    function loginDriver() {
      const id = document.getElementById("driverId").value.trim();
      const pass = document.getElementById("driverPass").value.trim();
      const email = id + "@busapp.com";
      const errorP = document.getElementById("loginError");

      if (!id || !pass) {
        errorP.innerText = "Driver ID ‡§î‡§∞ Password ‡§≠‡§∞‡•á‡§Ç";
        return;
      }

      auth.signInWithEmailAndPassword(email, pass)
        .then(() => {
          errorP.innerText = "";
          currentDriverId = id;
          document.getElementById("loginBox").style.display = "none";
          document.getElementById("driverPanel").style.display = "block";
          document.getElementById("driverName").innerText = currentDriverId;

          // ‡§∞‡•Ç‡§ü ‡§≤‡§æ‡§®‡§æ
          db.ref("drivers/" + currentDriverId + "/route").once("value").then(snapshot => {
            driverRoute = snapshot.val();
            if (!driverRoute) {
              alert("‡§Ü‡§™‡§ï‡§æ ‡§¨‡§∏ ‡§∞‡•Ç‡§ü ‡§∏‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§°‡§Æ‡§ø‡§® ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§");
            }
          });
        })
        .catch(error => {
          errorP.innerText = error.message;
        });
    }

    function startTracking() {
      if (!navigator.geolocation) {
        alert("‡§Ø‡§π ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ‡•§");
        return;
      }

      if (!driverRoute) {
        alert("‡§∞‡•Ç‡§ü ‡§∏‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Ö‡§™‡§°‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á‡•§");
        return;
      }

      document.getElementById("status").innerText = "‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§ü‡•ç‡§∞‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•Å‡§à...";
      document.getElementById("stopBtn").disabled = false;

      watchId = navigator.geolocation.watchPosition(position => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        // ‡§≤‡•ã‡§ï‡•á‡§∂‡§® Firebase ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç
        db.ref(driverRoute).set({
          lat: lat,
          lng: lng,
          updatedAt: Date.now()
        });

        document.getElementById("status").innerText = `‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Ö‡§™‡§°‡•á‡§ü: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
      }, error => {
        document.getElementById("status").innerText = "‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Ö‡§™‡§°‡•á‡§ü ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ: " + error.message;
      }, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
      });
    }

    function stopTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        document.getElementById("status").innerText = "‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Ö‡§™‡§°‡•á‡§ü ‡§¨‡§Ç‡§¶ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§";
        document.getElementById("stopBtn").disabled = true;
      }
    }

    function logoutDriver() {
      stopTracking();
      auth.signOut().then(() => {
        currentDriverId = null;
        driverRoute = null;
        document.getElementById("driverPanel").style.display = "none";
        document.getElementById("loginBox").style.display = "block";
        document.getElementById("driverId").value = "";
        document.getElementById("driverPass").value = "";
        document.getElementById("loginError").innerText = "";
        document.getElementById("status").innerText = "";
      });
    }
  </script>
</body>
</html>
